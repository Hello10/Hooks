{"version":3,"file":"index.js","sources":["../src/Singleton.ts","../src/useStateBlob.ts"],"sourcesContent":["import React from 'react';\n\nexport interface SingletonOptions<TState> {\n  state?: Partial<TState> | (()=> Partial<TState>);\n}\n\nexport class Singleton<TState, TOptions extends SingletonOptions<TState>> {\n  // eslint-disable-next-line @typescript-eslint/no-explicit-any\n  private static instance: any;\n  protected state: TState;\n  protected options: TOptions;\n  protected listeners: ((state: TState)=> void)[];\n\n  static use<\n    TState,\n    TOptions extends SingletonOptions<TState>,\n    TSingleton extends Singleton<TState, TOptions>\n  > (options: TOptions): TSingleton {\n    if (!this.instance) {\n      this.instance = new this(options);\n    }\n    const {instance} = this;\n    const [, setState] = React.useState<TState>();\n\n    React.useEffect(()=> {\n      // We need to explicitly track mount state to avoid\n      // setting state after a consumer is unmounted\n      let is_mounted = true;\n      function setStateIfMounted (state: TState) {\n        if (is_mounted) {\n          setState(state);\n        }\n      }\n\n      // We add a listener with each consumer's call\n      // to .use, and remove on umount\n      instance.addListener(setStateIfMounted);\n      return ()=> {\n        is_mounted = false;\n        instance.removeListener(setStateIfMounted);\n      };\n    }, []);\n\n    return instance;\n  }\n\n  constructor (options: TOptions) {\n    if ((this.constructor as typeof Singleton).instance) {\n      throw new Error(\"Don't call singleton constructor directly\");\n    }\n\n    this.options = options;\n    this.listeners = [];\n\n    // State can be either state object to set or function\n    // that returns the iniital state to be set\n    let state = {};\n    const {state: o_state} = this.options;\n    if (o_state) {\n      if (typeof o_state === 'function') {\n        state = o_state();\n      } else {\n        state = o_state;\n      }\n    }\n\n    this.state = this.initialize(state);\n  }\n\n  // Child classes can override .initialize for state initialization\n  protected initialize (state: Partial<TState>): TState {\n    return state as TState;\n  }\n\n  protected setState (state: Partial<TState>): void {\n    this.state = {\n      ...this.state,\n      ...state\n    };\n\n    for (const listener of this.listeners) {\n      listener(this.state);\n    }\n  }\n\n  private addListener (listener: (state: TState)=> void): void {\n    const {listeners} = this;\n    if (!listeners.includes(listener)) {\n      this.listeners = [...listeners, listener];\n    }\n  }\n\n  private removeListener (listener: (state: TState)=> void): void {\n    this.listeners = this.listeners.filter((l)=> l !== listener);\n  }\n}\n\nexport default Singleton;\n","import React, {useReducer} from 'react';\n\nexport function useStateBlob<State> (initial: State): [State, React.Dispatch<State>] {\n  return useReducer((state: State, delta: Partial<State>)=> {\n    return {\n      ...state,\n      ...delta\n    };\n  }, initial);\n}\n\nexport default useStateBlob;\n"],"names":["Singleton","use","options","instance","setState","React","useState","useEffect","is_mounted","setStateIfMounted","state","addListener","removeListener","constructor","listeners","Error","o_state","initialize","listener","includes","filter","l","useStateBlob","initial","useReducer","delta"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;MAMaA;AACX;AAMU,SAAHC,GAAG,CAIPC,OAJO;AAKR,QAAI,CAAC,KAAKC,QAAV,EAAoB;AAClB,WAAKA,QAAL,GAAgB,IAAI,IAAJ,CAASD,OAAT,CAAhB;AACD;;AACD,UAAM;AAACC,MAAAA;AAAD,QAAa,IAAnB;AACA,UAAM,GAAGC,QAAH,IAAeC,yBAAK,CAACC,QAAN,EAArB;AAEAD,IAAAA,yBAAK,CAACE,SAAN,CAAgB;AACd;AACA;AACA,UAAIC,UAAU,GAAG,IAAjB;;AACA,eAASC,iBAAT,CAA4BC,KAA5B;AACE,YAAIF,UAAJ,EAAgB;AACdJ,UAAAA,QAAQ,CAACM,KAAD,CAAR;AACD;AACF;AAGD;;;AACAP,MAAAA,QAAQ,CAACQ,WAAT,CAAqBF,iBAArB;AACA,aAAO;AACLD,QAAAA,UAAU,GAAG,KAAb;AACAL,QAAAA,QAAQ,CAACS,cAAT,CAAwBH,iBAAxB;AACD,OAHD;AAID,KAjBD,EAiBG,EAjBH;AAmBA,WAAON,QAAP;AACD;;AAEDU,EAAAA,YAAaX;SArCHQ;SACAR;SACAY;;AAoCR,QAAK,KAAKD,WAAL,CAAsCV,QAA3C,EAAqD;AACnD,YAAM,IAAIY,KAAJ,CAAU,2CAAV,CAAN;AACD;;AAED,SAAKb,OAAL,GAAeA,OAAf;AACA,SAAKY,SAAL,GAAiB,EAAjB;AAGA;;AACA,QAAIJ,KAAK,GAAG,EAAZ;AACA,UAAM;AAACA,MAAAA,KAAK,EAAEM;AAAR,QAAmB,KAAKd,OAA9B;;AACA,QAAIc,OAAJ,EAAa;AACX,UAAI,OAAOA,OAAP,KAAmB,UAAvB,EAAmC;AACjCN,QAAAA,KAAK,GAAGM,OAAO,EAAf;AACD,OAFD,MAEO;AACLN,QAAAA,KAAK,GAAGM,OAAR;AACD;AACF;;AAED,SAAKN,KAAL,GAAa,KAAKO,UAAL,CAAgBP,KAAhB,CAAb;AACD;;;AAGSO,EAAAA,UAAU,CAAEP,KAAF;AAClB,WAAOA,KAAP;AACD;;AAESN,EAAAA,QAAQ,CAAEM,KAAF;AAChB,SAAKA,KAAL,gBACK,KAAKA,KADV,EAEKA,KAFL;;AAKA,SAAK,MAAMQ,QAAX,IAAuB,KAAKJ,SAA5B,EAAuC;AACrCI,MAAAA,QAAQ,CAAC,KAAKR,KAAN,CAAR;AACD;AACF;;AAEOC,EAAAA,WAAW,CAAEO,QAAF;AACjB,UAAM;AAACJ,MAAAA;AAAD,QAAc,IAApB;;AACA,QAAI,CAACA,SAAS,CAACK,QAAV,CAAmBD,QAAnB,CAAL,EAAmC;AACjC,WAAKJ,SAAL,GAAiB,CAAC,GAAGA,SAAJ,EAAeI,QAAf,CAAjB;AACD;AACF;;AAEON,EAAAA,cAAc,CAAEM,QAAF;AACpB,SAAKJ,SAAL,GAAiB,KAAKA,SAAL,CAAeM,MAAf,CAAuBC,CAAD,IAAMA,CAAC,KAAKH,QAAlC,CAAjB;AACD;;;AAxFUlB,UAEIG;;SCNDmB,aAAqBC;AACnC,SAAOC,gBAAU,CAAC,CAACd,KAAD,EAAee,KAAf;AAChB,wBACKf,KADL,EAEKe,KAFL;AAID,GALgB,EAKdF,OALc,CAAjB;AAMD;;;;;"}