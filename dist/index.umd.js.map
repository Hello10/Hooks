{"version":3,"file":"index.umd.js","sources":["../src/Singleton.ts","../src/useStateBlob.ts"],"sourcesContent":["import React from 'react';\n\nexport interface SingletonOptions<TState> {\n  state?: Partial<TState> | (()=> Partial<TState>);\n}\n\nexport class Singleton<TState, TOptions extends SingletonOptions<TState>> {\n  // eslint-disable-next-line @typescript-eslint/no-explicit-any\n  private static instance: any;\n  protected state: TState;\n  protected options: TOptions;\n  protected listeners: ((state: TState)=> void)[];\n\n  static use<\n    TState,\n    TOptions extends SingletonOptions<TState>,\n    TSingleton extends Singleton<TState, TOptions>\n  > (options: TOptions): TSingleton {\n    if (!this.instance) {\n      this.instance = new this(options);\n    }\n    const {instance} = this;\n    const [, setState] = React.useState<TState>();\n\n    React.useEffect(()=> {\n      // We need to explicitly track mount state to avoid\n      // setting state after a consumer is unmounted\n      let is_mounted = true;\n      function setStateIfMounted (state: TState) {\n        if (is_mounted) {\n          setState(state);\n        }\n      }\n\n      // We add a listener with each consumer's call\n      // to .use, and remove on umount\n      instance.addListener(setStateIfMounted);\n      return ()=> {\n        is_mounted = false;\n        instance.removeListener(setStateIfMounted);\n      };\n    }, []);\n\n    return instance;\n  }\n\n  constructor (options: TOptions) {\n    if ((this.constructor as typeof Singleton).instance) {\n      throw new Error(\"Don't call singleton constructor directly\");\n    }\n\n    this.options = options;\n    this.listeners = [];\n\n    // State can be either state object to set or function\n    // that returns the iniital state to be set\n    let state = {};\n    const {state: o_state} = this.options;\n    if (o_state) {\n      if (typeof o_state === 'function') {\n        state = o_state();\n      } else {\n        state = o_state;\n      }\n    }\n\n    this.state = this.initialize(state);\n  }\n\n  // Child classes can override .initialize for state initialization\n  protected initialize (state: Partial<TState>): TState {\n    return state as TState;\n  }\n\n  protected setState (state: Partial<TState>): void {\n    this.state = {\n      ...this.state,\n      ...state\n    };\n\n    for (const listener of this.listeners) {\n      listener(this.state);\n    }\n  }\n\n  private addListener (listener: (state: TState)=> void): void {\n    const {listeners} = this;\n    if (!listeners.includes(listener)) {\n      this.listeners = [...listeners, listener];\n    }\n  }\n\n  private removeListener (listener: (state: TState)=> void): void {\n    this.listeners = this.listeners.filter((l)=> l !== listener);\n  }\n}\n\nexport default Singleton;\n","import React, {useReducer} from 'react';\n\nexport function useStateBlob<State> (initial: State): [State, React.Dispatch<State>] {\n  return useReducer((state: State, delta: Partial<State>)=> {\n    return {\n      ...state,\n      ...delta\n    };\n  }, initial);\n}\n\nexport default useStateBlob;\n"],"names":["Singleton","use","options","instance","setState","React","useState","useEffect","is_mounted","setStateIfMounted","state","addListener","removeListener","constructor","listeners","Error","o_state","initialize","listener","includes","filter","l","useStateBlob","initial","useReducer","delta"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;QAMaA;EACX;EAMU,SAAHC,GAAG,CAIPC,OAJO;EAKR,QAAI,CAAC,KAAKC,QAAV,EAAoB;EAClB,WAAKA,QAAL,GAAgB,IAAI,IAAJ,CAASD,OAAT,CAAhB;EACD;;EACD,UAAM;EAACC,MAAAA;EAAD,QAAa,IAAnB;EACA,UAAM,GAAGC,QAAH,IAAeC,yBAAK,CAACC,QAAN,EAArB;EAEAD,IAAAA,yBAAK,CAACE,SAAN,CAAgB;EACd;EACA;EACA,UAAIC,UAAU,GAAG,IAAjB;;EACA,eAASC,iBAAT,CAA4BC,KAA5B;EACE,YAAIF,UAAJ,EAAgB;EACdJ,UAAAA,QAAQ,CAACM,KAAD,CAAR;EACD;EACF;EAGD;;;EACAP,MAAAA,QAAQ,CAACQ,WAAT,CAAqBF,iBAArB;EACA,aAAO;EACLD,QAAAA,UAAU,GAAG,KAAb;EACAL,QAAAA,QAAQ,CAACS,cAAT,CAAwBH,iBAAxB;EACD,OAHD;EAID,KAjBD,EAiBG,EAjBH;EAmBA,WAAON,QAAP;EACD;;EAEDU,EAAAA,YAAaX;WArCHQ;WACAR;WACAY;;EAoCR,QAAK,KAAKD,WAAL,CAAsCV,QAA3C,EAAqD;EACnD,YAAM,IAAIY,KAAJ,CAAU,2CAAV,CAAN;EACD;;EAED,SAAKb,OAAL,GAAeA,OAAf;EACA,SAAKY,SAAL,GAAiB,EAAjB;EAGA;;EACA,QAAIJ,KAAK,GAAG,EAAZ;EACA,UAAM;EAACA,MAAAA,KAAK,EAAEM;EAAR,QAAmB,KAAKd,OAA9B;;EACA,QAAIc,OAAJ,EAAa;EACX,UAAI,OAAOA,OAAP,KAAmB,UAAvB,EAAmC;EACjCN,QAAAA,KAAK,GAAGM,OAAO,EAAf;EACD,OAFD,MAEO;EACLN,QAAAA,KAAK,GAAGM,OAAR;EACD;EACF;;EAED,SAAKN,KAAL,GAAa,KAAKO,UAAL,CAAgBP,KAAhB,CAAb;EACD;;;EAGSO,EAAAA,UAAU,CAAEP,KAAF;EAClB,WAAOA,KAAP;EACD;;EAESN,EAAAA,QAAQ,CAAEM,KAAF;EAChB,SAAKA,KAAL,gBACK,KAAKA,KADV,EAEKA,KAFL;;EAKA,SAAK,MAAMQ,QAAX,IAAuB,KAAKJ,SAA5B,EAAuC;EACrCI,MAAAA,QAAQ,CAAC,KAAKR,KAAN,CAAR;EACD;EACF;;EAEOC,EAAAA,WAAW,CAAEO,QAAF;EACjB,UAAM;EAACJ,MAAAA;EAAD,QAAc,IAApB;;EACA,QAAI,CAACA,SAAS,CAACK,QAAV,CAAmBD,QAAnB,CAAL,EAAmC;EACjC,WAAKJ,SAAL,GAAiB,CAAC,GAAGA,SAAJ,EAAeI,QAAf,CAAjB;EACD;EACF;;EAEON,EAAAA,cAAc,CAAEM,QAAF;EACpB,SAAKJ,SAAL,GAAiB,KAAKA,SAAL,CAAeM,MAAf,CAAuBC,CAAD,IAAMA,CAAC,KAAKH,QAAlC,CAAjB;EACD;;;EAxFUlB,UAEIG;;WCNDmB,aAAqBC;EACnC,SAAOC,gBAAU,CAAC,CAACd,KAAD,EAAee,KAAf;EAChB,wBACKf,KADL,EAEKe,KAFL;EAID,GALgB,EAKdF,OALc,CAAjB;EAMD;;;;;;;;;"}